---
  output: github_document
  indent: true
---

  <!-- README.md is generated from README.Rmd. Please edit that file -->

  ```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
  # out.width = "100%"
)
  ```
# CLIPreg

<!-- badges: start -->
  <!-- badges: end -->

  The goal of CLIPreg is to discover key RBP regulators in different datasets. It combines CLIP-seq with RNA- and RIBO-seq to calculate  enrichment of RBP and generate plots for publications.
  Another feature that can be analyzed by CLIPreg is enrichment of miRNA targets from TargetScan database.

## Installation

### Check and install required packages

Users may use following codes to check and install all the required packages.

``` r
list.of.packages <- c("ggplot2","grid","doParallel","foreach","data.table","fastmatch","GGally","ggnet","topGO","ALL","devtools","org.Hs.eg.db","DESeq2")

## for package "ggplot2", "pheatmap", "grid", "doParallel", "foreach", "data.table", "fastmatch", "GGally"
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

## for package "topGO", "ALL", "ggnet", "ComplexHeatmap","org.Hs.eg.db", "DESeq2"
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages))  BiocManager::install(new.packages)
if("ggnet"%in%new.packages)  devtools::install_github("briatte/ggnet")
devtools::install_version("network", version = "1.16.1", repos = "http://cran.us.r-project.org")
if("ComplexHeatmap"%in%new.packages)  devtools::install_github("jokergoo/ComplexHeatmap")
```

### Install CLIPreg

The source code of CLIPreg can be installed from [GitHub](https://github.com/) with:

  ``` r
devtools::install_github("SGDDNB/CLIPreg")
```

CLIPreg requires 4 different inputs. A gene_groups input which is a dataframe containing geneID and the gene_groups given by DeltaTE output (ideally). The DeltaTE method can be found in the paper here: https://doi.org/10.1002/cpmb.108. It categorizes transcriptionally and/or translationally regulated genes into 4 categories: forwarded, intensified, exclusive and buffered, each category with an up or down direction. A deltaTE function is included in this package, it can be found in advance usage step 0.
The 3 other required files are : summarized CLIP-seq data, with POSTAR and ENCODE which are pre-loaded in the package, RIBO log fold change (lfc) and TPM.

```{r load library, message=FALSE,warning=FALSE}
## load libraries
library(CLIPreg)
library(ggplot2)
library(ComplexHeatmap)
library(grid)
library(doParallel)
library(ggnet)
library(topGO)
library(GGally)
library(data.table)
library(stringr)
library(DESeq2)
```

## Basic usage

For testing the package with the example data. This will load the summary data of POSTAR and ENCODE as well as the TPM, lfc and gene_groups from the fibroblast dataset used in the paper.
```{r load example data, message=FALSE, eval=F}
Example=Load_example()
```

For using your own data, you must specify a folder that contains at least 3 txt files that are named: gene_groups.txt, ribo_lfc.txt and ribo_tpm.txt. For the format of those 3 files, please refer to Advance usage step 1.

```{r load user data, message=FALSE, eval=F}
Input_data=Load_input_files(folder = "path/to/folder")
```

Run the analysis with all default parameters.
```{r Run default analysis, message=FALSE, eval=F}
results=run_CLIPreg(Example, is.example=T) # or run_CLIPreg(Input_data, is.example=F)
```

Generate the visual output from the results of the analysis. The Visualise function will create 2 new files in the folder given: an Rdata file containing the list object from the run_CLIPreg function and a pdf file with the main figures. The results are created with all default parameters.

```{r RVisualize, message=FALSE,warning=FALSE, eval=F}
dir.create("Results_CLIPreg")
Visualise(results=results,folder="Results_CLIPreg")
```

## Advance usage

### Step 0 : Run deltaTE to find gene groups
This has to be done on your dataset from raw counts of RIBO and RNA as well as a coldata dataframe that can run through DESeq2. Put batch = 1 if you have a batch column in your design.
The counts must have a first column containing the geneID or gene names, they must be unique. The other columns are the raw counts of RNA and RIBO. The column names for the counts must be the same names as filled in the "SampleID" column of coldata.
The coldata dataframe must have column names "SampleID", "SeqType", "Condition" and "Batch". (Batch is an optional column). Condition must contain 1 and 2. For example, in an untreated vs treatment drug experiment, set the untreated sample condition to 1 and treatment to 2.

An example is provided in the github folder Example/Example_deltaTE.R . This function creates a folder in your current directory where it will write the DESeq2 output for RNA and RIBO as well as the gene lists of the different gene categories.

```{r create gene groups from deltaTE, message=FALSE, eval=F}
gene_groups=deltaTE_gene_groups(counts=counts,coldata=coldata,batch=0)
```




### Step 1: Input datasets

Let's have a look at the gene_groups file from the example data. It consists of 2 columns containing the "geneID" and the "Gene_group" for all the DE genes. This is as an example on fibroblasts stimulated by TGFB, if you start with your own gene groups, go to next step. Ideally, the gene groups are obtained from deltaTE analysis but any method to find gene groups can also be run.

```{r load gene_groups, message=FALSE}
data("gene_groups")
head(gene_groups)
```

You can input your own gene groups by using the function load_gene_groups() and giving the file location of your gene group file as input. Each gene group must contain "up" or "down" in the name or you won't be able to plot the network and gene ontology.

```{r load gene_groups from user, message=FALSE, eval=F}
gene_groups=load_gene_groups(gene_groups_file = "path/to/gene_groups_file.txt")
```

Load POSTAR and ENCODE RBP data. Those are 2 public datasets which are processed in order to have lists of vector. Each vector is named after 1 RBP and contains the geneID of all the targets of that RBP. Combine both data in a target list in the variable Targets.
combine_targets  function is a summary of both RBP data by filtering only targets which are present in the background. This is to save time for the later analysis in the clipreg function. 

```{r load RBP data, message=FALSE}
data("RBP_ENCODE")
data("RBP_POSTAR")
Targets=combine_targets(RBP_list1=RBP_ENCODE,RBP_list2=RBP_POSTAR,background=gene_groups$geneID)
```

Load the fold change and identify the RBPs. If you have your own then provide your own data.
ribo_lfc has 3 variables : "geneID", "IDENTIFIER" and "FoldChange". ribo_lfc only contains genes that have been filtered to be significantly changing at the ribo level.
tpm_ribo must have only counts as columns and geneID as rownames 

```{r loading LFC and TPM, message=FALSE}
# load fold change and tpm. optional if you want to use the input data
data("ribo_lfc")
data("tpm_ribo")

head(ribo_lfc)
#head(tpm_ribo)
```


To load your own data use
```{r loading your own LFC and TPM, message=FALSE,eval=F}
# If you want to input your own data
ribo_lfc=load_ribo_lfc(ribo_lfc_file = "ribo_lfc_file")
tpm_ribo=load_ribo_tpm(ribo_tpm_file = "ribo_tpm_file") # make sure rownames(tpm_ribo) corresponds to the geneID
```

### Step 2: Data integration and analysis

Run the enrichment analysis using CLIPreg() function. This takes several minutes depending on how many gene groups and how many genes per gene group there are. If you want to have a look at the example results skip this step.
For each RBP in each gene group, this function computes the over representation of the RBP's targets by calculating z-score, p-value and padj (corresponding to FDR).

The output of CLIPreg() is a list of dataframes. One dataframe per gene group containing the RBP and statistical information calculated during the analysis such as p-value and z-score.

```{r run enrichment analysis, message=FALSE,eval=F}
# The CLIPreg function requires a few minutes to run, save the data after running it to be sure not to lose it
res_Postar=CLIPreg(RBP_data=RBP_POSTAR,gene_groups=gene_groups)
res_Encode=CLIPreg(RBP_data=RBP_ENCODE,gene_groups=gene_groups)

save(res_Encode,file="Res_RBP_Encode.RData")
save(res_Postar,file="Res_RBP_Postar.RData")

```

If you want to get the results directly you can load it by using the example data results. 

```{r load res, message=FALSE}
data("res_Encode")
data("res_Postar")
head(res_Encode[[1]])
```

Then we want to combine POSTAR and ENCODE to work with only one dataframe and only keep RBPs that are significant in at least one gene group.

```{r combining POSTAR and ENCODE, message=FALSE}

res=CLIPreg::combine(res1=res_Encode,res2=res_Postar,FDR=0.1)
head(res[[1]])
```

Extract the RBP fold change from the ribo_lfc and keep only detected RBPs in res. If an RBP is not changing, it doesn't make sense to look at the enrichment of its targets so you should shortlist the RBP to only keep the changing ones.

```{r Extract LFC of RBPs, message=FALSE}
# Change of RBPs
rbp_lfc=rbp_change(res=res,ribo_lfc=ribo_lfc)
head(rbp_lfc)
# Cure res data by removing RBPs that are not in the rbp_lfc dataframe
res=cure_res(res=res,rbp_lfc=rbp_lfc)
#head(res)
```


### Step 3: Visualisation

Generate and save heatmap to pdf. The heatmap represents the -logP of each RBP for each gene group. The blue RBPs are downregulated and the orange RBPs are upregulated. Only RBPs with targets that are significantly enriched in at least one gene group are shown.

```{r Generate heatmap,fig.height=15,fig.width=10}
# Heatmap of RBP scores

HeatmapRBP(res=res,rbp_lfc=rbp_lfc)

# If there is not at least 1 positive and 1 negative RBP lfc then use the heatmap for miRNA
# HeatmapmiRNA(res=res)

```

Suggestion for saving your heatmap
```{r save heatmap to pdf, eval=F}
# Save the heatmap
e=HeatmapRBP(res=res,rbp_lfc=rbp_lfc)
location="Heatmap_fibroblasts.pdf"
n=length(e$tree_row$order)
pdf(location,length(names(res)),3+n*0.15)
e
dev.off()
```

A bubble plot can be generated to see the overall representation of the RBPs' targets. This can only be done if the gene groups are generated from deltaTE_gene_groups function or with gene groups having similar names to deltaTE groups.

```{r Bubble plot, message=FALSE}
# Bubble plot gene_groups if gene_groups are from DeltaTE. FDR has to be lower or equal to the FDR put in CLIPreg::combine() step
BubbleRBPs(res = res,gene_groups = gene_groups,rbp_lfc = rbp_lfc,FDR=0.05)
```

From the results, the user can choose a number of RBP to draw the network for by n. This will pick the n most changing RBPs based on fold change for the network. In the case where the user wants to draw a network with specific RBPs, he can input rpb_lfc as a character vector containing the RBP of interest

```{r Network,message=FALSE,warning=FALSE}
# Draw network of the RBP that are most changing or choose specific RBPs
Draw_network_by_group(rbp_lfc=rbp_lfc,res=res,Targets=Targets,gene_groups=gene_groups,n=5,forwarded = F)

# You can subset your RBP_lfc to keep only your RBPs of interest
# Draw_network_by_group(rbp_lfc=c("CELF2","HNRNPF","DDX24"),
#                       res=res,Targets=Targets,gene_groups=gene_groups,n=5,forwarded = F)
```

```{r GO of specific nodes,fig.width=15, message=FALSE,warning=FALSE}
# plot GO
Plot_GO(rbp_lfc=rbp_lfc,res=res,Targets=Targets,gene_groups=gene_groups,n=5,
  tpm_ribo = tpm_ribo,th=200,GO_to_show=3,forwarded = F)
Plot_GO_node_name(rbp_lfc=rbp_lfc,res=res,Targets=Targets,gene_groups=gene_groups,n=5,
                  tpm_ribo = tpm_ribo,Nodes_to_keep=c(19,15),GO_to_show=3,forwarded = F)
Plot_GO_RBP(rbp_of_interest="QKI",tpm_ribo = tpm_ribo,Targets=Targets,gene_groups=gene_groups,GO_to_show=3)
```


## Analysis of miRNA target enrichment

The same analysis can be applied to run miRNA target enrichment. Here is an example of the code that is very similar to the steps followed for the RBPs.

```{r Scipt for miRNA,eval=F}

data("miR_data") # preparation can be found in Example/data_processing.R on github
data("miR_info")
data("gene_groups") # for example on fibroblasts
Targets=GetTarget(RBP_data=miR_data,background=gene_groups$geneID)
data("ribo_lfc")
data("tpm_ribo")
data("tpm_all_RNA")

tpm_all_RNA=tpm_all_RNA[rowSums(tpm_all_RNA > 0) >= 1, ]
miR_info=miR_info[miR_info$ensembl_gene_id%in%rownames(tpm_all_RNA),]
names(miR_data)=tolower(names(miR_data))
miR_data=subset(miR_data,names(miR_data)%in%tolower(miR_info$mirbase_id))

#res_miR=CLIPreg(RBP_data=miR_data,gene_groups=gene_groups) # Takes several minutes
#save(res_miR,file="Res_miR0.5.RData")
data("Res_miR")
res=CLIPreg::combine(res1=res_miR,res2 = res_miR,FDR=0.1)
HeatmapmiRNA(res=res)


# Save the heatmap
e=HeatmapmiRNA(res=res)
location="Heatmap_HeLa_EGF_miRNA.pdf"
n=nrow(e@matrix)
pdf(location,length(names(res))+3,3+n*0.15)
e
dev.off()


# Network and GO
Draw_network_by_group(rbp_lfc=c("hsa-miR-133a-3p.1","hsa-miR-590-5p","hsa-miR-29a-3p","hsa-miR-30a-5p","hsa-miR-155-5p"),res=res,Targets=Targets,gene_groups=gene_groups,n=5,forwarded = F)
Plot_GO_RBP(rbp_of_interest="hsa-miR-155-5p",tpm_ribo = tpm_ribo,Targets=Targets,gene_groups=gene_groups,GO_to_show=3)
```



## Another example

HeLa stimulated by EGF. groups were obtained by categorizing into TE up and down from data given in the paper. Data preparation can be found in Example/data_processing.R on github.

``` {r CLIPreg on HeLa stimulated by EGF, fig.width=15, message=FALSE,warning=FALSE,eval=F}
# RBP analysis
data("gene_groups_HeLa_EGF")
data("ribo_lfc_HeLa_EGF")
data("tpm_ribo_HeLa_EGF.RData")

data("RBP_ENCODE")
data("RBP_POSTAR")
Targets=combine_targets(RBP_list1=RBP_ENCODE,RBP_list2=RBP_POSTAR,background=gene_groups$geneID)

res_Postar=CLIPreg(RBP_data=RBP_POSTAR,gene_groups=gene_groups)
res_Encode=CLIPreg(RBP_data=RBP_ENCODE,gene_groups=gene_groups)

res=CLIPreg::combine(res1=res_Encode,res2=res_Postar,FDR=0.1)
rbp_lfc=rbp_change(res=res,ribo_lfc=ribo_lfc)
res=cure_res(res=res,rbp_lfc=rbp_lfc)

HeatmapmiRNA(res=res) # The RBP are not changing --> need to use the miRNA heatmap
Draw_network_by_group(rbp_lfc=c("GRWD1","GRSF1","SUGP2","DHX30","LSM11"),res=res,Targets=Targets,gene_groups=gene_groups,n=5,forwarded = F)
Plot_GO_RBP(rbp_of_interest="GRWD1",tpm_ribo = tpm_ribo,Targets=Targets,gene_groups=gene_groups,GO_to_show=3)

# miRNA analysis

data("gene_groups_HeLa_EGF")
data("ribo_lfc_HeLa_EGF")
data("tpm_ribo_HeLa_EGF.RData")
data("tpm_all_RNA_HeLa_EGF")
data("miR_data")
data("miR_info")


tpm_all_RNA=tpm_all_RNA[rowSums(tpm_all_RNA > 1) >= 1, ]
miR_info=miR_info[miR_info$ensembl_gene_id%in%rownames(tpm_all_RNA),]
names(miR_data)=tolower(names(miR_data))
miR_data=subset(miR_data,names(miR_data)%in%tolower(miR_info$mirbase_id))



res_miR=CLIPreg(RBP_data=miR_data,gene_groups=gene_groups)
#save(res_miR,file="Res_miR_HeLa_EGF.RData")
res=CLIPreg::combine(res1=res_miR,res2=res_miR,FDR=0.1)

HeatmapmiRNA(res=res) # The RBP are not changing --> need to use the miRNA heatmap
Targets=GetTarget(RBP_data=miR_data,background=gene_groups$geneID)
Draw_network_by_group(rbp_lfc=c("hsa-miR-652-3p","hsa-miR-499a-5p","hsa-miR-99b-5p","hsa-miR-875-5p","hsa-miR-501-3p"),res=res,Targets=Targets,gene_groups=gene_groups,n=5,forwarded = F)
Plot_GO_RBP(rbp_of_interest="hsa-miR-501-3p",tpm_ribo=tpm_ribo,Targets=Targets,gene_groups=gene_groups,
            GO_to_show=3)
```






