---
  output: github_document
  indent: true
---

  <!-- README.md is generated from README.Rmd. Please edit that file -->

  ```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
  # out.width = "100%"
)
  ```
# CLIPreg

<!-- badges: start -->
  <!-- badges: end -->

  The goal of CLIPreg is to discover key RBP regulators in different datasets. It combines CLIP-seq with RNA- and RIBO-seq to calculate  enrichment of RBP and generate plots for publications.

## Installation

### Check and install required packages

Users may use following codes to check and install all the required packages.

``` r
list.of.packages <- c("ggplot2","grid","doParallel","foreach","data.table","fastmatch","GGally","ggnet","topGO","ALL","devtools")

## for package "ggplot2", "pheatmap", "grid", "doParallel", "foreach", "data.table", "fastmatch", "GGally"
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

## for package "topGO", "ALL", "ggnet", "ComplexHeatmap"
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages))  BiocManager::install(new.packages)
if("ggnet"%in%new.packages)  devtools::install_github("briatte/ggnet")
install_version("network", version = "1.16.1", repos = "http://cran.us.r-project.org")
if("ComplexHeatmap"%in%new.packages)  devtools::install_github("jokergoo/ComplexHeatmap")
```

### Install CLIPreg

The source code of CLIPreg can be installed from [GitHub](https://github.com/) with:

  ``` r
devtools::install_github("SGDDNB/CLIPreg")
```

CLIPreg requires 4 different inputs. A cluster input which is a dataframe containing geneID and the cluster given by DeltaTE output (ideally).
Curated CLIP-seq data, POSTAR and ENCODE are pre-loaded in the package. RIBO lfc and TPM.

```{r load library, message=FALSE,warning=FALSE}
## load libraries
library(CLIPreg)
library(ggplot2)
library(ComplexHeatmap)
library(grid)
library(doParallel)
library(ggnet)
library(topGO)
library(GGally)
library(data.table)
library(stringr)
```

### Basic usage

For testing the package with the example data
```{r load example data, message=FALSE}
Example=Load_example()
```

For using your own data, you must specify a folder that contains at least 3 txt files that are named: clusters.txt, ribo_lfc.txt and ribo_tpm.txt. For the format of those 3 files, please refer to Advance usage step 1.

```{r load user data, message=FALSE}
#Input_data=Load_input_files(folder = "path/to/folder")
```

Run the analysis with all default parameters.
```{r Run default analysis, message=FALSE}
results=run_CLIPreg(Example, is.example=T) # or run_CLIPreg(Input_data, is.example=F)
```

Generate the visual output from the results of the analysis. The Visualise function will create 2 new files in the folder given: an Rdata file containing the list object from the run_CLIPreg function and a pdf file with the main figures.

```{r Run default analysis, message=FALSE}
Visualise(results=results,folder=getwd())
```

### Advance usage

## Step 1: Input datasets

Let's have a look at the cluster file from the example data. It consists of 2 columns containing the geneID and the cluster for all the DE genes. This is optional, if you want to provide your own clusters, go to next step.

```{r load clusters, message=FALSE}
data("clusters")
head(clusters)
```

You can input your own clusters by using the function load_clusters() and giving the file location of your file as input.

```{r load clusters from user, message=FALSE}
#clusters=load_clusters(cluster_file = "cluster_file")
```

Load POSTAR and ENCODE RBP data. Those are 2 public datasets which are processed in order to have lists of vector. Each vector is named after 1 RBP and contains the geneID of all the targets of that RBP. Combine both data in a target list. 

```{r load RBP data, message=FALSE}
data("RBP_ENCODE")
data("RBP_POSTAR")
Targets=combine_targets(RBP_list1=RBP_ENCODE,RBP_list2=RBP_POSTAR,background=clusters$geneID)
```

Load the fold change and identify the RBPs. If you have your own then provide your own data.

```{r loading LFC and TPM, message=FALSE}
# load fold change and tpm. optional if you want to use the input data
data("ribo_lfc")
data("tpm_ribo")

head(ribo_lfc)
head(tpm_ribo)

# If you want to input your own data
#load_ribo_lfc(ribo_lfc_file = "ribo_lfc_file")
#load_ribo_tpm(ribo_tpm_file = "ribo_tpm_file")

```

## Step 2: Data integration and analysis

Run the enrichment analysis using CLIPReg_V4() function. This takes several minutes. If you want to have a look at the example results skip this step.

```{r run enrichment analysis, message=FALSE}
# The CLIPreg_V4 function requires a few minutes to run, save the data after running it to be sure not to lose it
# res_Postar=CLIPReg_V4(RBP_data=RBP_POSTAR,clusters=clusters)
# res_Encode=CLIPReg_V4(RBP_data=RBP_ENCODE,clusters=clusters)
# save(res_Encode,file="Res_RBP_Encode.RData")
# save(res_Postar,file="Res_RBP_Postar.RData")
```

If you want to get the results directly you can load it by using the example data results. The output of CLIPReg_V4() is a list of dataframes. One dataframe per cluster containing the RBP and statistical information calculated during the analysis such as p-value and z-score.

```{r load res, message=FALSE}
data("Res_Encode")
data("Res_Postar")
head(res_Encode[[1]])
```

Then we want to combine POSTAR and ENCODE to work with only one dataframe and only keep RBPs that are significant in at least one cluster.

```{r combining POSTAR and ENCODE, message=FALSE}

res=CLIPreg::combine(res1=res_Encode,res2=res_Postar)

```

Extract the RBP LFC from the RIBO_LFC and keep only detected RBPs in res

```{r Extract LFC of RBPs, message=FALSE}
# Change of RBPs
rbp_lfc=rbp_change(res=res,ribo_lfc=ribo_lfc)

# Cure res data by removing RBPs that are not in the rbp_lfc dataframe
res=cure_res(res=res,rbp_lfc=rbp_lfc)
```


## Step 3: Visualisation

Generate and save heatmap to pdf. The heatmap represents the -logP of each RBP for each cluster. The blue RBPs are downregulated and the orange RBPs are upregulated. Only RBPs that are significant in at least one cluster are shown.

```{r Generate and save heatmap, message=FALSE}
# Heatmap of RBP scores

HeatmapRBP(res=res,rbp_lfc=rbp_lfc)
# Plot the heatmap with updated colors for the RBPs

# Save the heatmap
# e=HeatmapRBP(res=res,rbp_lfc=rbp_lfc)
# location="Heatmap_fibroblasts.pdf"
# n=length(e$tree_row$order)
# pdf(location,8,3+n*0.15)
# 
# dev.off()
```

A bubble plot can be generated only if the clusters are the output of DeltaTE program.

```{r Bubble plot, message=FALSE}
# Bubble plot clusters if clusters are from DeltaTE
BubbleRBPs(RBP_res = res,clusters = clusters,rbp_lfc = rbp_lfc)
```

From the results, the user can choose a number of RBP to draw the network for by n. This will pick the n most changing RBPs.

```{r Network, message=FALSE}
# Draw network
Draw_network_by_group(rbp_lfc=rbp_lfc,res=res[-c(1,2)],Targets=Targets,clusters=clusters,n=5)
```

```{r GO of specific nodes, message=FALSE}
# plot GO
Plot_GO(rbp_lfc=rbp_lfc,res=res[-c(1,2)],Targets=Targets,clusters=clusters,n=5,
  tpm_ribo = tpm_ribo,th=200,GO_to_show=3)
Plot_GO_node_name(rbp_lfc=rbp_lfc,res=res[-c(1,2)],Targets=Targets,clusters=clusters,n=5,
                  tpm_ribo = tpm_ribo,Nodes_to_keep=c(19,15),GO_to_show=3)
Plot_GO_RBP(rbp_of_interest="QKI",tpm_ribo = tpm_ribo,Targets=Targets,clusters=clusters,GO_to_show=3)
```
